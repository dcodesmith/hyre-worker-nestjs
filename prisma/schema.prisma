generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Car {
  id                 String             @id @default(cuid())
  make               String
  model              String
  year               Int
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  color              String
  ownerId            String
  registrationNumber String
  status             Status
  approvalStatus     CarApprovalStatus  @default(PENDING)
  approvalNotes      String?
  hourlyRate         Int
  dayRate            Int
  nightRate          Int
  fuelUpgradeRate    Int
  fullDayRate        Int
  bookings           Booking[]
  owner              User               @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  documents          DocumentApproval[] @relation("CarDocuments")
  images             VehicleImage[]

  @@index([ownerId])
  @@index([ownerId, updatedAt])
  @@index([ownerId, approvalStatus])
  @@index([approvalStatus])
  @@index([status])
  @@index([updatedAt(sort: Desc), dayRate])
}

model User {
  id                      String                   @id @default(cuid())
  email                   String                   @unique
  username                String?                  @unique
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  address                 String?
  city                    String?
  fleetOwnerId            String?
  name                    String?
  phoneNumber             String?
  fleetOwnerStatus        FleetOwnerStatus?        @default(PROCESSING)
  chauffeurApprovalStatus ChauffeurApprovalStatus? @default(PENDING)
  hasOnboarded            Boolean                  @default(false)
  // Referral fields
  referralCode            String?                  @unique
  referredByUserId        String?
  referralAttributionSource ReferralAttributionSource?
  referralSignupAt        DateTime?
  referralDiscountUsed    Boolean                  @default(false)
  
  bankDetails             BankDetails?             @relation("UserBankDetails")
  bookingsAsChauffeur     Booking[]                @relation("BookingChauffeur")
  bookings                Booking[]                @relation("BookingCustomer")
  cars                    Car[]
  approvedDocuments       DocumentApproval[]       @relation("ApprovedBy")
  documents               DocumentApproval[]       @relation("UserDocuments")
  payoutsReceived         PayoutTransaction[]      @relation("FleetOwnerPayouts")
  fleetOwner              User?                    @relation("FleetOwnerChauffeurs", fields: [fleetOwnerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  chauffeurs              User[]                   @relation("FleetOwnerChauffeurs")
  approvedVehicleImages   VehicleImage[]           @relation("ApprovedVehicleImages")
  roles                   Role[]                   @relation("RoleToUser")
  // Referral relations
  referredBy              User?                    @relation("UserReferrals", fields: [referredByUserId], references: [id])
  referrals               User[]                   @relation("UserReferrals")
  referralStats           UserReferralStats?
  referralAttribution     ReferralAttribution?     @relation("RefereeAttribution")
  referralAttributions    ReferralAttribution[]    @relation("ReferrerAttributions")
  referralRewardsEarned   ReferralReward[]         @relation("ReferrerRewards")
  referralRewardsFrom     ReferralReward[]         @relation("RefereeRewards")
  bookingReferrals        Booking[]                @relation("BookingReferrals")

  @@index([fleetOwnerId])
  @@index([fleetOwnerStatus, hasOnboarded])
  @@index([hasOnboarded])
  @@index([id, email])
  @@index([referralCode])
  @@index([referredByUserId])
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String   @default("")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]   @relation("RoleToUser")
}

model Booking {
  id                                      String                   @id @default(cuid())
  createdAt                               DateTime                 @default(now())
  updatedAt                               DateTime                 @updatedAt
  status                                  BookingStatus            @default(PENDING)
  startDate                               DateTime
  endDate                                 DateTime
  totalAmount                             Decimal                  @db.Decimal(10, 2)
  paymentStatus                           PaymentStatus            @default(UNPAID)
  paymentId                               String?
  carId                                   String
  userId                                  String?
  pickupLocation                          String
  returnLocation                          String
  specialRequests                         String?
  chauffeurId                             String?
  cancelledAt                             DateTime?
  cancellationReason                      String?
  guestUser                               Json?
  type                                    BookingType              @default(DAY)
  paymentIntent                           String?
  fleetOwnerPayoutAmountNet               Decimal?                 @db.Decimal(10, 2)
  netTotal                                Decimal?                 @db.Decimal(10, 2)
  overallPayoutStatus                     PayoutTransactionStatus?
  platformCustomerServiceFeeAmount        Decimal?                 @db.Decimal(10, 2)
  platformCustomerServiceFeeRatePercent   Decimal?                 @db.Decimal(5, 2)
  platformFleetOwnerCommissionAmount      Decimal?                 @db.Decimal(10, 2)
  platformFleetOwnerCommissionRatePercent Decimal?                 @db.Decimal(5, 2)
  subtotalBeforeVat                       Decimal?                 @db.Decimal(10, 2)
  vatAmount                               Decimal?                 @db.Decimal(10, 2)
  vatRatePercent                          Decimal?                 @db.Decimal(5, 2)
  bookingReference                        String                   @unique
  securityDetailCost                      Decimal?                 @db.Decimal(10, 2)
  fuelUpgradeCost                         Decimal?                 @db.Decimal(10, 2)
  // Referral fields
  referralReferrerUserId                  String?
  referralDiscountAmount                  Decimal                  @db.Decimal(10, 2) @default(0)
  referralStatus                          BookingReferralStatus    @default(NONE)
  referralCreditsUsed                     Decimal                  @db.Decimal(10, 2) @default(0)
  referralCreditsReserved                 Decimal                  @db.Decimal(10, 2) @default(0)
  
  car                                     Car                      @relation(fields: [carId], references: [id])
  chauffeur                               User?                    @relation("BookingChauffeur", fields: [chauffeurId], references: [id])
  user                                    User?                    @relation("BookingCustomer", fields: [userId], references: [id])
  referralReferrer                        User?                    @relation("BookingReferrals", fields: [referralReferrerUserId], references: [id])
  legs                                    BookingLeg[]
  customerPayments                        Payment[]                @relation("BookingCustomerPayments")
  payoutTransactions                      PayoutTransaction[]      @relation("BookingPayouts")
  referralRewards                         ReferralReward[]

  @@index([bookingReference])
  @@index([carId])
  @@index([userId])
  @@index([status])
  @@index([chauffeurId])
  @@index([paymentStatus])
  @@index([paymentIntent])
  @@index([overallPayoutStatus])
  @@index([startDate, endDate, status])
  @@index([chauffeurId, status, startDate, endDate])
  @@index([carId, paymentStatus, status, startDate, endDate])
  @@index([type, endDate])
  @@index([referralStatus])
  @@index([referralStatus, status])
  @@index([userId, paymentStatus, referralCreditsUsed])
  @@index([userId, paymentStatus, referralCreditsReserved])
}

model BookingLeg {
  id                            String      @id @default(cuid())
  bookingId                     String
  legDate                       DateTime    @db.Date
  totalDailyPrice               Decimal     @db.Decimal(10, 2)
  notes                         String?
  createdAt                     DateTime    @default(now())
  updatedAt                     DateTime    @updatedAt
  legEndTime                    DateTime
  legStartTime                  DateTime
  fleetOwnerEarningForLeg       Decimal     @db.Decimal(10, 2)
  itemsNetValueForLeg           Decimal     @db.Decimal(10, 2)
  platformCommissionAmountOnLeg Decimal?    @db.Decimal(10, 2)
  platformCommissionRateOnLeg   Decimal?    @db.Decimal(5, 2)
  booking                       Booking     @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  extensions                    Extension[]

  @@unique([bookingId, legDate])
  @@index([bookingId])
  @@index([legDate])
}

model Extension {
  id                                      String                   @id @default(cuid())
  createdAt                               DateTime                 @default(now())
  updatedAt                               DateTime                 @updatedAt
  totalAmount                             Decimal                  @db.Decimal(10, 2)
  paymentStatus                           PaymentStatus            @default(UNPAID)
  paymentId                               String?
  paymentIntent                           String?
  status                                  String                   @default("PENDING")
  bookingLegId                            String
  eventType                               ExtensionEventType
  extendedDurationHours                   Int
  extensionEndTime                        DateTime
  extensionStartTime                      DateTime
  fleetOwnerPayoutAmountNet               Decimal?                 @db.Decimal(10, 2)
  netTotal                                Decimal?                 @db.Decimal(10, 2)
  overallPayoutStatus                     PayoutTransactionStatus?
  platformCustomerServiceFeeAmount        Decimal?                 @db.Decimal(10, 2)
  platformCustomerServiceFeeRatePercent   Decimal?                 @db.Decimal(5, 2)
  platformFleetOwnerCommissionAmount      Decimal?                 @db.Decimal(10, 2)
  platformFleetOwnerCommissionRatePercent Decimal?                 @db.Decimal(5, 2)
  subtotalBeforeVat                       Decimal?                 @db.Decimal(10, 2)
  vatAmount                               Decimal?                 @db.Decimal(10, 2)
  vatRatePercent                          Decimal?                 @db.Decimal(5, 2)
  bookingLeg                              BookingLeg               @relation(fields: [bookingLegId], references: [id], onDelete: Cascade)
  customerPayments                        Payment[]                @relation("ExtensionCustomerPayments")
  payoutTransactions                      PayoutTransaction[]      @relation("ExtensionPayouts")

  @@index([bookingLegId])
  @@index([paymentStatus])
  @@index([eventType])
  @@index([status])
  @@index([overallPayoutStatus])
}

model Payment {
  id                       String               @id @default(cuid())
  bookingId                String?
  extensionId              String?
  txRef                    String               @unique
  flutterwaveTransactionId String?              @unique
  flutterwaveReference     String?              @unique
  amountExpected           Decimal              @db.Decimal(10, 2)
  amountCharged            Decimal?             @db.Decimal(10, 2)
  currency                 String
  feeChargedByProvider     Decimal?             @db.Decimal(10, 2)
  status                   PaymentAttemptStatus
  paymentProviderStatus    String?
  paymentMethod            String?
  initiatedAt              DateTime             @default(now())
  confirmedAt              DateTime?
  lastVerifiedAt           DateTime?
  webhookPayload           Json?
  verificationResponse     Json?
  booking                  Booking?             @relation("BookingCustomerPayments", fields: [bookingId], references: [id])
  extension                Extension?           @relation("ExtensionCustomerPayments", fields: [extensionId], references: [id])

  @@index([bookingId])
  @@index([extensionId])
  @@index([txRef])
  @@index([flutterwaveTransactionId])
  @@index([flutterwaveReference])
  @@index([status])
}

model PayoutTransaction {
  id                      String                  @id @default(cuid())
  fleetOwnerId            String
  bookingId               String?                 @unique
  extensionId             String?
  amountToPay             Decimal                 @db.Decimal(10, 2)
  amountPaid              Decimal?                @db.Decimal(10, 2)
  currency                String
  status                  PayoutTransactionStatus
  payoutProviderReference String?
  payoutMethodDetails     String?
  initiatedAt             DateTime                @default(now())
  processedAt             DateTime?
  completedAt             DateTime?
  notes                   String?
  booking                 Booking?                @relation("BookingPayouts", fields: [bookingId], references: [id])
  extension               Extension?              @relation("ExtensionPayouts", fields: [extensionId], references: [id])
  fleetOwner              User                    @relation("FleetOwnerPayouts", fields: [fleetOwnerId], references: [id])

  @@index([fleetOwnerId])
  @@index([status])
  @@index([extensionId])
}

model DocumentApproval {
  id           String         @id @default(cuid())
  documentType DocumentType
  status       DocumentStatus @default(PENDING)
  documentUrl  String
  notes        String?
  approvedById String?
  approvedAt   DateTime?
  carId        String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  userId       String?
  approvedBy   User?          @relation("ApprovedBy", fields: [approvedById], references: [id])
  car          Car?           @relation("CarDocuments", fields: [carId], references: [id], onDelete: Cascade)
  user         User?          @relation("UserDocuments", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([documentType, userId])
  @@unique([documentType, carId])
  @@index([status])
  @@index([documentType])
}

model VehicleImage {
  id           String         @id @default(cuid())
  url          String
  carId        String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  approvedAt   DateTime?
  approvedById String?
  notes        String?
  status       DocumentStatus @default(PENDING)
  approvedBy   User?          @relation("ApprovedVehicleImages", fields: [approvedById], references: [id])
  car          Car            @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@index([carId])
  @@index([status])
}

model TaxRate {
  id             String    @id @default(cuid())
  ratePercent    Decimal   @db.Decimal(5, 2)
  effectiveSince DateTime  @unique
  effectiveUntil DateTime?
  description    String?   @default("Nigerian VAT")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([effectiveSince, effectiveUntil])
}

model PlatformFeeRate {
  id             String          @id @default(cuid())
  feeType        PlatformFeeType
  ratePercent    Decimal         @db.Decimal(5, 2)
  effectiveSince DateTime
  effectiveUntil DateTime?
  description    String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@unique([feeType, effectiveSince])
  @@index([feeType, effectiveSince, effectiveUntil])
}

model AddonRate {
  id             String    @id @default(cuid())
  addonType      AddonType
  rateAmount     Decimal   @db.Decimal(10, 2)
  effectiveSince DateTime
  effectiveUntil DateTime?
  description    String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([addonType, effectiveSince])
  @@index([addonType, effectiveSince, effectiveUntil])
}

model BankDetails {
  id                   String    @id @default(cuid())
  userId               String    @unique
  bankName             String
  bankCode             String
  accountNumber        String
  accountName          String
  isVerified           Boolean   @default(false)
  lastVerifiedAt       DateTime?
  verificationResponse Json?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  user                 User      @relation("UserBankDetails", fields: [userId], references: [id], onDelete: Cascade)
}

enum Status {
  AVAILABLE
  BOOKED
  HOLD
  IN_SERVICE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  ACTIVE
  COMPLETED
  CANCELLED
  REJECTED
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
  PARTIALLY_REFUNDED
  REFUND_PROCESSING
  REFUND_FAILED
}

enum BookingType {
  DAY
  NIGHT
  FULL_DAY
}

enum ExtensionEventType {
  HOURLY_ADDITION
  NEW_DAY_ADDITION
}

enum PaymentAttemptStatus {
  PENDING
  SUCCESSFUL
  FAILED
  REFUNDED
  REFUND_PROCESSING
  REFUND_FAILED
  PARTIALLY_REFUNDED
}

enum PayoutTransactionStatus {
  PENDING_APPROVAL
  PENDING_DISBURSEMENT
  PROCESSING
  PAID_OUT
  FAILED
  REVERSED
}

enum CarApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum FleetOwnerStatus {
  PROCESSING
  APPROVED
  ON_HOLD
  ARCHIVED
}

enum ChauffeurApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DocumentType {
  NIN
  DRIVERS_LICENSE
  MOT_CERTIFICATE
  INSURANCE_CERTIFICATE
  VEHICLE_IMAGES
  CERTIFICATE_OF_INCORPORATION
}

enum PlatformFeeType {
  PLATFORM_SERVICE_FEE
  FLEET_OWNER_COMMISSION
}

enum AddonType {
  SECURITY_DETAIL
}

enum ReferralAttributionSource {
  LINK
  MANUAL
  IMPORT
}

enum ReferralRewardStatus {
  PENDING
  RELEASED
  REVERSED
}

enum ReferralReleaseCondition {
  PAID
  COMPLETED
}


enum BookingReferralStatus {
  NONE
  APPLIED
  REWARDED
  REVERSED
}

model UserReferralStats {
  id                  String    @id @default(cuid())
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  userId              String    @unique
  totalReferrals      Int       @default(0)
  totalRewardsGranted Decimal   @db.Decimal(10, 2) @default(0)
  totalRewardsPending Decimal   @db.Decimal(10, 2) @default(0)
  lastReferralAt      DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ReferralAttribution {
  id            String                    @id @default(cuid())
  createdAt     DateTime                  @default(now())
  refereeUserId String                    @unique
  referrerUserId String
  referralCode  String
  source        ReferralAttributionSource
  ipAddress     String?
  userAgent     String?
  sessionId     String?
  securityFlags Json?

  referee  User @relation("RefereeAttribution", fields: [refereeUserId], references: [id], onDelete: Cascade)
  referrer User @relation("ReferrerAttributions", fields: [referrerUserId], references: [id], onDelete: Cascade)

  @@index([referrerUserId])
}

model ReferralReward {
  id                 String                      @id @default(cuid())
  createdAt          DateTime                    @default(now())
  updatedAt          DateTime                    @updatedAt
  referrerUserId     String
  refereeUserId      String
  bookingId          String
  amount             Decimal                     @db.Decimal(10, 2)
  status             ReferralRewardStatus        @default(PENDING)
  releaseCondition   ReferralReleaseCondition
  reason             String?
  processedAt        DateTime?

  referrer User    @relation("ReferrerRewards", fields: [referrerUserId], references: [id], onDelete: Cascade)
  referee  User    @relation("RefereeRewards", fields: [refereeUserId], references: [id], onDelete: Cascade)
  booking  Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([referrerUserId])
  @@index([refereeUserId])
  @@index([bookingId])
  @@index([status, createdAt])
  @@index([status, bookingId])
  @@index([status, processedAt])
}

model ReferralProgramConfig {
  key       String   @id
  value     Json
  updatedAt DateTime @updatedAt
  updatedBy String?
}
